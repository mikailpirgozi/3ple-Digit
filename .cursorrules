# 3PLE DIGIT ‚Äì CURSOR RULES

## CONTEXT DETECTION
- BACKEND edits ‚Üí apply BACKEND rules (`/apps/api/src/**`, `/prisma/**`).
- FRONTEND edits ‚Üí apply FRONTEND rules (`/apps/web/src/**`).
- If both: keep changes scoped per module; pick the safest approach and state why in 1‚Äì2 sentences.

## UNIVERSAL
- Language: odpovede po slovensky; k√≥d/koment√°re po anglicky.
- TypeScript strict; **no `any`**. Use `unknown` + type guards/Zod.
- Validation at boundaries: every API input/output must have Zod schema.
- ESLint + Prettier + Husky pre-commit. Lint must be clean.
- Conventional Commits, Commitlint. CI must pass tests & prisma migrate.
- ENV only via typed loader `src/lib/env.ts` (fail fast if missing).
- Structured logging (`log({reqId,userId,...}, msg)`), no raw `console.log`.
- Security: Helmet, CORS (whitelist), rate-limit on write endpoints.
- R2: use presigned uploads; store only `r2_key`, `mime`, `size`, `sha256`.

## TYPESCRIPT SAFETY RULES (MANDATORY)
- **exactOptionalPropertyTypes: true** - NEVER use `undefined` for Prisma nullable fields, use `null`
- Router params: ALWAYS use `validateRequiredParam(req.params.id, 'id')` instead of destructuring
- Unused params: Use `_req`, `_res`, `_next` prefix for unused Express parameters
- Prisma updates: Use `this.toNullable()` helper for optional fields, `this.filterUpdateData()` for updates
- Type assertions: Prefer type guards over `as` assertions, use `!` only when 100% sure
- Array access: Use `array[0]!` or `array.at(0)` with null checks for safe access

## MODULARIZATION & FILE SIZE
- Architecture: **by-feature** folders (investors, assets, bank, liabilities, snapshots, documents, reports, auth, core, ui).
- Each backend module contains: `schema.ts` (Zod), `service.ts`, `router.ts` (or `controller.ts`), `tests/`.
- Each frontend feature contains: `ui/` components (small), `api.ts` (clients), `hooks/`, `types/`, `tests/`.
- Barrel `index.ts` exports only public surface.
- **Limits:** No file > 300 LOC. UI component ~‚â§150 LOC. If larger, split into subcomponents/hooks.
- Route-level code splitting: pages are lazy-loaded.

## BACKEND
- Stack: Node/TS (Express or tRPC) + Prisma + PostgreSQL.
- Error handler returns `{ error: { code, message, details? } }` consistently.
- Role guard: ADMIN/INTERNAL/INVESTOR. Server-side enforce investor scoping.
- CSV import: robust parser with Zod; report per-line errors.
- Prisma: all schema changes via migrations; never destructive ops without migration.
- Tests: Vitest (unit) & supertest (integration). Provide seed data for tests.

### MANDATORY PATTERNS FOR NEW CODE:
```typescript
// ‚úÖ Router parameter validation
const id = validateRequiredParam(req.params.id, 'id');

// ‚úÖ Prisma service helpers
private toNullable<T>(value: T | undefined): T | null {
  return value === undefined ? null : value;
}

private filterUpdateData<T extends Record<string, any>>(data: T): any {
  const filtered: any = {};
  for (const [key, value] of Object.entries(data)) {
    if (value !== undefined) {
      filtered[key] = value;
    }
  }
  return filtered;
}

// ‚úÖ Prisma create/update operations
data: {
  name: data.name,
  description: this.toNullable(data.description),
}

// ‚úÖ Unused parameters
router.get('/path', asyncHandler(async (_req, res) => {
```

## FRONTEND
- Stack: React + Vite + Tailwind + TanStack Query + RHF (with Zod resolver).
- State: server state in Query, local UI state in hooks. No Redux.
- Forms: shared `<FormField>`; inline validation errors; accessible labels.
- Tables: server-side filtering + pagination. For very large datasets, propose keyset.
- UX: dark/light, a11y (`jsx-a11y`), ErrorBoundary, sensible loading/empty states.
- Optimistic updates: disabled for money-critical actions (snapshots, cashflows).

## DOMAIN (MVP)
- Entities: `investor`, `investor_cashflow`, `asset`, `asset_event`, `liability`, `bank_balance`, `period_snapshot`, `document`, `audit_log`.
- NAV = Œ£ `asset.current_value` + Œ£ `bank_balance.amount` ‚àí Œ£ `liability.current_balance`.
- Investor capital = Œ£ (deposits ‚àí withdrawals) + allocated PnL.
- Ownership % = investor_capital / Œ£ investor_capital.
- Performance fee: optional flat rate; allocate 50/50 for managers; no HWM in MVP.
- Snapshot: manual action "Ulo≈æi≈• snapshot" ‚Üí server computes & persists.

## TESTS & QUALITY GATES
- Unit (Vitest): NAV, ownership %, fee allocation, CSV parser, asset_event‚Üícurrent_value.
- Integration (supertest): 
  1) deposit ‚Üí snapshot % change,
  2) valuation+capex ‚Üí NAV change,
  3) snapshot ‚Üí reports data.
- E2E (Playwright): single smoke: add asset ‚Üí valuation ‚Üí snapshot.
- CI must run lint, unit, integration; fail build on any error/warning (treat TS errors as fatal).

## FILE SIZE & SPLIT
- Ak s√∫bor presiahne limit, Cursor MUS√ç navrhn√∫≈• rozdelenie (zoznam nov√Ωch s√∫borov + ƒço do ktor√©ho ide) a urobi≈• to.

## TEST-FIRST FOR CORE LOGIC
- Pri nov√Ωch v√Ωpoƒçtoch (NAV, fee, ownership) najprv vytvor testy so vzorkami d√°t, a≈æ potom implement√°ciu.

## COMMUNICATION WITH CURSOR
- If multiple valid solutions: pick **safer/cleaner**, explain briefly; ask only when ambiguity risks breaking behavior.
- Provide diffs and "how to test" steps with every larger change.
- Prefer minimal diffs; for >200 LOC changes, outline a short refactor plan first.

## DATABASE PROTECTION RULES (CRITICAL - NEVER VIOLATE)
- ‚ùå **NEVER** use `prisma migrate reset` - DELETES ALL DATA
- ‚ùå **NEVER** use `prisma db push --force-reset` - DELETES ALL DATA  
- ‚ùå **NEVER** use `prisma db push --force` - DELETES ALL DATA
- ‚ùå **NEVER** drop/replace existing tables with data
- ‚ùå **NEVER** use destructive database operations without explicit user consent
- ‚úÖ **ALWAYS** use `prisma migrate dev` to ADD new fields/tables
- ‚úÖ **ALWAYS** use `prisma db push` for development schema sync
- ‚úÖ **ALWAYS** preserve existing data when adding schema changes
- ‚úÖ **ALWAYS** ask before any operation that could affect existing data
- üö® **CRITICAL**: User's Railway PostgreSQL database contains valuable production data that must NEVER be deleted

## DO / DON'T
- ‚úÖ Use typed helpers (`env`, `api`, `log`, `flags`), shared Zod schemas.
- ‚úÖ Keep modules isolated; export types from `/packages/types` if shared.
- ‚úÖ Keep components small; extract hooks for logic.
- ‚ùå No secrets in code/rules. No `any`. No silent failures. No giant files.
